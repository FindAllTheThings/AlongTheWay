<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">
    <!--
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/menu.css">
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="/css/list.css">
    -->
    <link rel="stylesheet" href="bundle.css" />

    <title>Along the Way</title>

    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places"></script>

    <script>

    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;
    var service
    var infowindow;
    var markers = [];

    function initialize() {
      directionsDisplay = new google.maps.DirectionsRenderer();
      var mapOptions = {
        zoom: 16,
        center: {lat: 47.6097, lng: -122.3331}
      };
      map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);
      directionsDisplay.setMap(map);
      infowindow = new google.maps.InfoWindow();
      service = new google.maps.places.PlacesService(map);
    }

    function calcRoute() {
      // Clear any previous route boxes from the map
      deleteMarkers();

      var request = {
        origin: document.getElementById("address").value,
        destination: document.getElementById("address2").value,
        travelMode: google.maps.DirectionsTravelMode.DRIVING
      }

  // Make the directions request
      directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(result);
          var path = result.routes[0].overview_path;
          findPlaces(path, 0);
        } else {
          alert("Directions query failed: " + status);
        }
      });
    }

    function findPlaces(path, index) {
     var type = document.getElementById('choose').value;
     var radius = document.getElementById('radius').value * 1609.34
     var timeout = 50;

     function loop() {
       var request = {
         location: path[index],
         radius: radius,
         types: [type]
       };
       service.radarSearch(request, function (results, status) {
         if (status == google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
           return;
         }
         if (status == google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {

           timeout += timeout;
           return;
         }

         timeout = 50;

         for (var i = 0, result; result = results[i]; i++) {
           var marker = createMarker(result);
         }

       });
       if (index++ < path.length)
        setTimeout(loop, timeout);
      }
      loop();
    }

function setAllMap(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}

function createMarker(place) {
  var marker = new google.maps.Marker({
    map: map,
    position: place.geometry.location
  });
  markers.push(marker);
  google.maps.event.addListener(marker, 'click', function() {
    service.getDetails(place, function(result, status) {
      if (status != google.maps.places.PlacesServiceStatus.OK) {
        console.log(status);
        return;
      }
      name = result.name;
      add = result.formatted_address;
      infowindow.setContent('<p>' + name + '</p><p>' + add + '</p>');
      infowindow.open(map, marker);
    });
  });
}

function deleteMarkers() {
  setAllMap(null);
  markers = [];
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>

  </head>

  <body>

    <div id="options-wrapper" class="open">

      <div id="progress-bar"></div>

        <div id="opt-inner-wrapper">
            <div id="panel">

              <div>
                <label>Start</label>
                <input id="address" type="text">
              </div>

              <div>
                <label>Destination</label>
                <input id="address2" type="text">
              </div>

              <div>
                <label>Search Distance (from route)</label>
                <select id="radius">
                  <option value=".25">1/4 mile</option>
                  <option value=".5">1/2 mile</option>
                  <option value="1">1 mile</option>
                  <option value="2">2 miles</option>
                  <option value="5">5 miles</option>
                  <option value="10">10 miles</option>
                </select>
              </div>

              <div>
                <select id="choose">
                  <option value="restaurant">Restaurant</option>
                  <option value="bank">Bank</option>
                  <option value="lodging">Lodging</option>
                  <option value="store">Store</option>
                </select>
              </div>
            </div>

            <div>
              <input id="go" type="submit" value="Go!" onclick="calcRoute()">
            </div>
        </div>

        <div id="overlay-handle">
            <img src="icons/menu.png"  />
        </div>
    </div>


    <div id="map-wrapper">
      <div id="map-canvas"></div>
    </div>

    <div id="results-section">
      <div id="results-item" class=""></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script charset="utf-8">
      $(function(){
        $('#overlay-handle').on('click',function(){
          $('#options-wrapper').toggleClass('open');
        });

        $('#go').on('click', function(){
          $('#options-wrapper').toggleClass('open');
        });
      });
    </script>

</body>
</html>
